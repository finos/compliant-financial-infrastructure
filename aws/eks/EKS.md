# EKS

**Overview**

This document is meant to provide an opinionated approach towards the implementation of security controls, by domain, in EKS. Although the approaches may not be fit for all use cases or complete for production use, they are meant to guide the reader towards current best practices and design considerations to achieve security control objectives.

**Terms**

- Amazon = AWS
- Identity & Access Management = IAM
- Kubernetes = K8s
- Role-based Access Control = RBAC

**Components & Shared Responsibility**

An EKS cluster consists of two primary components:

- EKS control plane
- EKS nodes registered with the control plane

From a shared responsibility model perspective, AWS is responsible for the EKS control plane.

The EKS control plane is composed of:

- at least two API server nodes
- three etcd nodes

AWS provisions the cluster's control plane, within an AWS-managed VPC, across multiple availability zones (AZs) and is fronted by an elastic load balancing (ELB) network load balancer (NLB).

It also provisions EKS-managed elastic network interfaces (ENIs) in your VPC subnets to provide connectivity from the control plane instances to the nodes.

As for the customer, the responsibility is to look after: IAM, pod security, runtime security, and network security.

**VPC**

AWS recommends the user to create a VPC with public and private subnets so that K8s can create public load balancers in the public subnets that load balance traffic to pods running on nodes that are in private subnets.

**Controls and Architecture Best Practices**

This table maps each security domain to the corresponding controls and architectural best practices as documented in EKSâ€™s public documentation, white papers, and blog posts.

| **Security Domain** | **Controls & Architectural Best Practices** | **Reference(s)** |
| ------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Encryption** |
| Encryption - Data at Rest | By default, all of the data stored by etcd nodes and associated AWS EBS volumes is encrypted using AWS KMS.<br/><br/>When a new cluster is created, you can choose to enable envelope encryption of K8s secrets using AWS KMS.<br/><br/>If you enable envelope encryption, the K8s secrets are encrypted using the customer master key (CMK) that you select.<br/><br/>The CMK must be symmetric and created in the same region as the cluster. If the CMK was created with a different account, the user must have access to the CMK.<br/><br/>From a security standpoint, enabling envelop encryption for K8s secrets using AWS KMS is encouraged if secrets are going to be handled with the native K8s functionality in the cluster. Otherwise, secrets won't be encrypted, just stored as base64 in etcd. |
| **Infrastructure** |
| Infrastructure - Cluster Endpoint(s) Access | When a new cluster is created, EKS creates an endpoint for the EKS-managed K8s API server that you use to communicate with your cluster.<br/><br/>By default, this K8s API server endpoint is public to the Internet and access to the K8s API server is secured using a combination of AWS IAM and native K8s RBAC.<br/><br/>When only the public endpoint is enabled, which is the default, K8s API requests that originate from within your cluster's VPC (e.g. node to control plane communication) leave your VPC, but not Amazon's network.<br/><br/>Technically, the following endpoint combinations are supported:<br/>- public endpoint enabled and private endpoint disabled<br/>- public and private endpoints enabled<br/>- private endpoint enabled and public endpoint disabled<br/><br/>From a security standpoint, the cluster endpoint access, ideally, must be set to use only the private endpoint.<br/><br/>After setting it to private, EKS creates a Route 53 private hosted zone on your behalf and associates it with your cluster's VPC. Note that this private hosted zone is managed by AWS EKS and it doesn't appear in your account's Route 53 resources.<br/><br/>In order for the private hosted zone to properly route traffic to your API server, your VPC must have **enableDnsHostnames** and **enableDnsSupport** set to true, and the DHCP options set for your VPC must include **AmazonProvidedDNS** in its domain name servers list. | - [Cluster Endpoint Access](https://docs.aws.amazon.com/eks/latest/userguide/cluster-endpoint.html)<br/><br/>- [Working with Private Hosted Zones](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zones-private.html)<br/><br/>- [VPC and Subnet Sizing](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html#VPC_Sizing)<br/><br/>- [De-mystifying Cluster Networking for AWS EKS Worker Nodes](https://aws.amazon.com/blogs/containers/de-mystifying-cluster-networking-for-amazon-eks-worker-nodes/) |
| Infrastructure - Worker Nodes | AWS EKS supports:<br/>- AWS EC2: managed node groups<br/>- AWS EC2: self-managed nodes<br/>- AWS Fargate<br/><br/>Security considerations must be taken if you choose to use AWS EC2 self-managed nodes.<br/><br/>If access is required to the worker nodes, instead of enabling SSH access, use SSM Session Manager to remote into them. It provides an audit trail and log of the commands that were run on the instance. | - [EKS Worker Nodes](https://aws.github.io/aws-eks-best-practices/hosts/) |
| Infrastructure - Storage | EKS supports three AWS native storage options:<br/>- EBS<br/>- EBF<br/>-FSx for Lustre<br/><br/>All three offer encryption at rest using a service managed key or a customer managed key. | - [K8s AWS EBS](https://kubernetes.io/docs/concepts/storage/storage-classes/#aws-ebs) |
| **Logging & Monitoring** | AWS EKS control plane logging provides audit and diagnostic logs directly from the AWS EKS control plane to AWS CloudWatch Logs in your account. Furthermore, you can enable or disable each log type on a per-cluster basis.<br/><br/>From a security standpoint, you should monitor at the very least: **api** and **audit** logs. Also, put special attention to changes on RBAC objects: Roles, RoleBindings, ClusterRoles, and ClusterRoleBindings. | - [EKS Control Plane Logging](https://docs.aws.amazon.com/eks/latest/userguide/control-plane-logs.html) |
| **Networking & Isolation** |
| Networking & Isolation - Security Groups | EKS clusters, starting with K8s version 1.14 and platform version **eks.3**, create a cluster security group when they are created.<br/><br/>**A cluster security group is designed to allow all traffic from the control plane and managed node groups to flow freely between each other.** By assigning the cluster security group to the control plane cross-account network interfaces and the managed node group instances, you don't need to configure complex security group rules to allow this communication.<br/><br/>When you create an EKS cluster with versions ealier to both of the referenced above, EKS requires you to specify a security group.<br/><br/>This security group effectively becomes the cluster security group.<br/><br/>From a security standpoint, in this scenario, you should use a dedicated security group for each cluster control plane (one per cluster).<br/><br/>If this security group is shared with other resources, you might block or disrupt connections to those resources. Furthermore, it will affect maintainability and traceability. | - [AWS EKS Security Group Considerations](https://docs.aws.amazon.com/eks/latest/userguide/sec-group-reqs.html) |
| **Authentication** | EKS natively supports:<br/>- webhook token authentication<br/>- service account tokens<br/><br/>K8s natively supports:<br/>- bearer tokens<br/>- client certificates<br/>- authenticating proxy, e.g. LDAP, SAML, Kerberos, alternate x509 schemes, OIDC, etc.<br/>- HTTP basic auth<br/><br/>The webhook token authentication strategy, which is native in K8s, calls a webhook that verifies bearer tokens.<br/><br/>On EKS, these bearer tokens are generated by the AWS CLI or the **aws-iam-authenticator** client when kubectl commands are executed.<br/><br/>By using the AWS CLI, from version 1.16.156 onwards, the authentication token can be manually generated by:<br/><br/>**aws eks get-token --cluster-name \<value\> [--role-arn \<value\>]**<br/><br/>role-arn indicates the role to assume for credentials when signing the token.<br/><br/>Each token starts with **k8s-aws-v1.**, followed by a base64 encoded string.<br/><br/>In other words, the token itself is a pre-signed URL (AWS STS) and it has a TTL of 15 minutes.<br/><br/>From a security standpoint, these are the following recommendations:<br/>- Don't use a service account token for authentication.<br/>- Employ least privileged access to AWS resources.<br/>- Use IAM roles when multiple users need identical access to the cluster: map roles to RBAC groups.<br/>- Employ least privileged access when creating RoleBindings and ClusterRoleBindings.<br/>- Regularly audit access to the cluster. | - [K8s Authentication](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)<br/>- [K8s Webhook Token Authentication](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#webhook-token-authentication)<br/>- [AWS IAM Authenticator](https://github.com/kubernetes-sigs/aws-iam-authenticator)<br/>- [EKS API - get-token](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/eks/get-token.html) |
| **Authorization** | When a cluster is created, the IAM entity (e.g. user, role, federated user, etc.) that creates it is automatically granted **system:masters** permissions in the cluster's RBAC configuration.<br/><br/>This is achieved by the creation of a ConfigMap named **aws-auth** in the **kube-system** namespace.<br/><br/>In other words, the ConfigMap is used to handle the IAM users and roles permissions within the cluster. The ConfigMap also handles the nodes joining the cluster. | - [Managing Users or IAM Roles for Your Cluster](https://docs.aws.amazon.com/eks/latest/userguide/add-user-role.html) |
| Authorization - IAM Roles for Service Accounts - IRSA | This feature allows assigning an IAM role to a K8s service account. It works by leveraging a K8s feature known as **Service Account Token Volume Projection**.<br/><br/>Pods with service accounts that reference an IAM role call a public OIDC discovery endpoint for AWS IAM upon pod's startup. The endpoint cryptographically signs the OIDC toekn issued by K8s which ultimately allows the pod to call the AWS APIs associated IAM role.<br/><br/>When an AWS API is invoked, within the pod, the AWS SDKs calls **sts:AssumeRoleWithIdentity** and automatically exchanges the K8s issued token for an AWS temporary credential.<br/><br/>A mutating webhook that runs as part of the EKS control plane injects the AWS Role ARN and the path to a web identity token file into the pod as environment variables:<br/>- AWS_ROLE_ARN<br/>- AWS_WEB_IDENTITY_TOKEN_FILE<br/><br/>The kubelet will automatically rotate the projected token when it is older than 80% of its total TTL or after 24 hours. The AWS SDKs are responsible for reloading the token when it rotates.<br/><br/>From a security standpoint, these are the following recommendations:<br/>- Update the aws-node daemonset to use IRSA.<br/>- Restrict access to the instance profile assigned to the worker node.<br/>- Scope the IAM role trust policy for IRSA to the service account name.<br/>- When the application needs access to IDMS, use IDMSv2 and increase the hop limit on EC2 instances to 2.<br/>- Disable auto-mounting of service account tokens.<br/>- Use dedicated service accounts for each application.<br/>- Run the application as a non-root user.<br/>- Grant least privileged access to applications. | - [Restrict Access to the Instance Profile Assigned to the Worker Node](https://aws.github.io/aws-eks-best-practices/iam/#restrict-access-to-the-instance-profile-assigned-to-the-worker-node)